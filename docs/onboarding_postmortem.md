# LoRA 写真数据集自动构建平台 - Onboarding Postmortem

## 1. 项目概述

### 1.1 项目定位
LoRA 写真数据集自动构建平台是一个高效、灵活的工具，用于自动化生成 LoRA 模型训练所需的写真数据集。该项目支持本地 CLI 和 Web UI 两种运行模式，专注于隐私保护和高性能处理。

### 1.2 核心价值
- **自动化处理**：从原始图片到训练数据集的全流程自动化
- **隐私优先**：本地模式无需上传原始图片，保护用户隐私
- **超高分辨率支持**：轻松处理长边 3000+ 像素的图片
- **双模式运行**：满足不同场景需求

### 1.3 典型应用场景
- 摄影爱好者构建个人写真数据集
- AI 模型训练团队快速生成高质量训练数据
- 隐私敏感场景下的数据集构建

## 2. 项目结构与架构

### 2.1 目录结构

```
lora-dataset-builder/
├── backend/                 # FastAPI后端服务
│   ├── app/                 # 后端核心代码
│   ├── requirements.txt     # 后端依赖
│   └── Dockerfile           # Docker构建文件
├── client/                  # 本地Python CLI工具
│   ├── src/                 # CLI源代码
│   └── requirements.txt     # CLI依赖
├── config/                  # 配置文件
│   └── ports.json           # 端口配置
├── frontend/                # Vue前端应用
│   ├── src/                 # 前端源代码
│   └── package.json         # 前端依赖
└── docker-compose.yml       # Docker Compose配置
```

### 2.2 架构设计

#### 后端架构
- **API 层**：FastAPI 提供 RESTful API 和 SSE 实时通信
- **服务层**：核心业务逻辑（图像处理、模型调用、去重等）
- **数据层**：SQLAlchemy + SQLite 轻量级数据存储
- **任务层**：异步任务处理，支持进度实时更新

#### 前端架构
- **组件化设计**：基于 Vue3 + TypeScript 的组件化开发
- **状态管理**：localStorage 存储用户配置
- **API 交互**：Axios + SSE 实现前后端通信

### 2.3 数据流

1. **上传阶段**：用户上传 ZIP 文件或选择文件夹
2. **处理阶段**：后端异步处理（解压 -> 去重 -> 预览 -> 焦点检测 -> 裁剪 -> 打标）
3. **进度反馈**：通过 SSE 实时推送进度信息
4. **结果展示**：前端展示处理结果和预览图
5. **下载阶段**：用户下载最终的训练数据集

## 3. 技术栈与依赖

### 3.1 后端技术栈
| 技术/依赖 | 版本/说明 | 用途 |
|----------|----------|------|
| FastAPI | 0.110.0 | Web 框架 |
| Uvicorn | 0.29.0 | ASGI 服务器 |
| SQLAlchemy | 2.0.27 | ORM 框架 |
| Pydantic | 2.6.1 | 数据验证 |
| Pillow | 10.2.0 | 图像处理 |
| NumPy | 1.26.4 | 数值计算 |
| OpenAI SDK | 1.13.3 | 模型调用 |
| InsightFace | 0.7.3 | 人脸检测与识别 |
| MediaPipe | 0.10.14 | 姿势估计 |

### 3.2 前端技术栈
| 技术/依赖 | 版本/说明 | 用途 |
|----------|----------|------|
| Vue3 | ^3.4.21 | 前端框架 |
| TypeScript | ^5.2.2 | 类型安全 |
| Element Plus | ^2.5.6 | UI 组件库 |
| Vue Router | ^4.3.0 | 路由管理 |
| Axios | ^1.6.7 | HTTP 客户端 |
| Vite | ^5.2.0 | 构建工具 |

### 3.3 本地 CLI 技术栈
| 技术/依赖 | 版本/说明 | 用途 |
|----------|----------|------|
| Python | 3.10+ | 开发语言 |
| Typer | - | CLI 框架 |
| Pillow | 10.2.0 | 图像处理 |
| NumPy | 1.26.4 | 数值计算 |

## 4. 关键功能模块

### 4.1 自动处理流程

**处理流程**：解压 -> 去重 -> 预览生成 -> 焦点检测 -> 1024x1024 裁剪 -> 智能打标 -> 打包输出

**核心实现**：
- 解压：使用 Python 标准库处理 ZIP 文件
- 去重：基于 pHash 和图像特征的高效去重算法
- 焦点检测：调用视觉模型检测图像核心区域
- 裁剪：根据焦点区域精确裁剪 1024x1024 图像
- 打标：使用视觉语言模型生成详细图像标签

### 4.2 去重功能

**实现原理**：
- **人脸特征提取**：使用 InsightFace 提取人脸特征向量
- **相似度计算**：基于余弦相似度和 SSIM 进行人脸匹配
- **聚类算法**：DBSCAN 聚类算法实现人脸聚类
- **姿态分析**：MediaPipe 进行人体姿态估计，辅助去重

**关键参数**：
```python
# 默认去重参数
DEFAULT_DEDUP_PARAMS = {
    "face_sim_th1": 0.75,   # 人脸相似度阈值1
    "face_sim_th2": 0.85,   # 人脸相似度阈值2
    "pose_sim_th": 0.7,     # 姿态相似度阈值
    "face_ssim_th1": 0.8,   # 人脸SSIM阈值1
    "face_ssim_th2": 0.9,   # 人脸SSIM阈值2
    "bbox_tol_c": 0.1,      # 边界框中心容忍度
    "bbox_tol_wh": 0.1,     # 边界框宽高容忍度
    "keep_per_cluster": 2   # 每簇保留图片数量
}
```

### 4.3 模型调用服务

**实现特点**：
- 兼容 OpenAI SDK 的模型客户端
- 支持自定义模型服务地址
- 多模型优先级配置
- 自动重试机制
- 回退模型策略

**核心代码**：
```python
# 模型客户端调用示例
response = self._call_model(messages)
```

### 4.4 Web UI 功能

**主要功能**：
- 多文件上传与管理
- 实时任务进度展示
- 图像处理结果预览
- 交互式裁剪调整
- 自定义模型服务配置
- 结果下载

## 5. 配置与部署

### 5.1 端口配置

配置文件：`config/ports.json`

```json
{
  "backend_port": 8081,
  "backend_host": "0.0.0.0",
  "frontend_port": 8080,
  "redis_port": 6379
}
```

### 5.2 环境变量

**后端环境变量**：
- `DATABASE_URL`: 数据库连接字符串
- `REDIS_URL`: Redis 连接字符串
- `MODELSCOPE_TOKEN`: ModelScope API 令牌
- `BASE_URL`: 模型服务地址

**前端配置**：
- 通过 localStorage 存储用户配置
- 支持动态切换 API 服务地址

### 5.3 部署方式

#### 开发环境部署

**后端启动**：
```bash
cd backend
pip install -r requirements.txt
python -m uvicorn app.main:app --host 0.0.0.0 --port 8081
```

**前端启动**：
```bash
cd frontend
npm install
npm run dev
```

#### Docker 部署

```bash
docker-compose up -d
```

## 6. 常见问题与解决方案

### 6.1 后端启动失败

**问题**：`ModuleNotFoundError: No module named 'app'`

**解决方案**：
- 确保从正确的目录启动：`backend` 目录
- 使用正确的命令：`python -m uvicorn app.main:app`

### 6.2 前端端口冲突

**问题**：`Error: Port 8080 is already in use`

**解决方案**：
- 终止占用端口的进程：
  ```bash
  netstat -ano | findstr :8080
  taskkill /PID <PID> /F
  ```
- 或修改 `config/ports.json` 中的 `frontend_port`

### 6.3 模型调用失败

**问题**：API 调用超时或返回错误

**解决方案**：
- 检查 API 令牌是否有效
- 检查网络连接
- 调整模型服务地址
- 查看日志获取详细错误信息

### 6.4 图像处理缓慢

**解决方案**：
- 检查系统资源使用情况
- 确保使用了合适的硬件加速
- 考虑使用本地 CLI 模式以提高速度

## 7. 改进建议

### 7.1 架构改进

1. **引入消息队列**：使用 Redis 或 RabbitMQ 替代当前的线程池，提高任务处理的可靠性和可扩展性

2. **数据库优化**：
   - 考虑支持 PostgreSQL 等更强大的数据库
   - 添加索引优化查询性能
   - 实现数据分区策略

3. **前后端分离优化**：
   - 考虑使用 JWT 认证
   - 实现更细粒度的权限控制
   - 优化 CORS 配置

### 7.2 功能增强

1. **图像处理增强**：
   - 添加更多图像处理选项（如滤镜、增强等）
   - 支持批量编辑功能
   - 实现更智能的裁剪算法

2. **模型集成**：
   - 支持更多模型服务提供商
   - 实现模型本地部署支持
   - 添加模型性能监控

3. **用户体验**：
   - 实现更直观的任务管理界面
   - 添加任务模板功能
   - 实现批量操作功能

### 7.3 性能优化

1. **并行处理**：
   - 优化图像处理的并行度
   - 实现任务队列优先级
   - 添加任务调度功能

2. **内存管理**：
   - 优化大图片处理的内存使用
   - 实现更高效的图像缓存策略
   - 添加资源使用监控

3. **缓存机制**：
   - 实现图像处理结果缓存
   - 添加模型调用结果缓存
   - 优化静态资源加载

### 7.4 可维护性改进

1. **测试覆盖**：
   - 增加单元测试和集成测试
   - 实现自动化测试流程
   - 添加性能测试

2. **日志系统**：
   - 优化日志结构和级别
   - 实现日志集中管理
   - 添加日志分析工具

3. **文档完善**：
   - 完善 API 文档
   - 添加开发指南
   - 实现用户手册

## 8. 结论

LoRA 写真数据集自动构建平台是一个功能完整、架构清晰的项目，具有良好的扩展性和可维护性。该项目通过双模式设计满足了不同场景的需求，同时注重隐私保护和性能优化。

项目目前处于稳定运行状态，但仍有改进空间，特别是在架构扩展性、功能增强和性能优化方面。通过实施上述改进建议，可以进一步提升项目的竞争力和用户体验。

## 9. 快速入门指南

### 9.1 Web UI 模式

1. **配置端口**：编辑 `config/ports.json`（可选）
2. **启动后端**：
   ```bash
   cd backend && pip install -r requirements.txt && python -m uvicorn app.main:app --host 0.0.0.0 --port 8081
   ```
3. **启动前端**：
   ```bash
   cd frontend && npm install && npm run dev
   ```
4. **访问应用**：http://localhost:8080

### 9.2 本地 CLI 模式

```bash
cd client
pip install -r requirements.txt
pip install -e .
lora-dataset-builder run-all --input input_root --output output_root
```

## 10. 联系方式与支持

- 项目仓库：当前目录
- 文档：`docs/` 目录
- API 文档：`docs/api.md`
- 测试脚本：各模块下的 `test_*.py` 文件

---

**报告生成日期**：2026-01-14
**报告版本**：1.0.0
**生成工具**：自动生成
